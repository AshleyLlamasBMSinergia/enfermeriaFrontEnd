<div class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header text-secondary border-0">
                <h3 class="card-title text-center">Generar movimiento de lotes</h3>
            </div>
            <form [formGroup]="movimientoForm" (submit)="guardar()">
                <div class="card-body">
                    <div>
                        <div class="form-group">
                            <label class="col-form-label">
                                Tipo de movimiento
                                <span class="text-danger">*</span>
                            </label>
                            <ngx-select [items]="movimientoTipos" name="movimientoTipo_id" formControlName="movimientoTipo_id" (select)="tipoDeMovimiento($event)">
                                <ng-content select="value"></ng-content>
                            </ngx-select>
                        </div>
                    </div>
                    <div *ngIf="movimientoForm.get('movimientoTipo_id')?.value">
                        <label class="col-form-label">
                            Mover lotes
                        </label>
                        <div [formGroup]="formInsumos">
                            <div class="card shadow-none">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="col-form-label">
                                        Insumos
                                        <span class="text-danger">*</span>
                                    </label>
                                    <ngx-select
                                        [multiple]="true"
                                        [formControlName]="'insumos'"
                                        [allowClear]="true"
                                        [items]="insumos"
                                        optionValueField="id"
                                        optionTextField="nombre"
                                        placeholder="Select..."
                                        (select)="addItemInsumo($event)"
                                        (remove)="deleteInsumo($event)">
                                    </ngx-select>
                                </div>
                                <div formArrayName="itemInsumo">
                                    <div *ngFor="let insumoSeleccionado of insumosForm().controls; let insIndex = index">
                                        <div class="mb-1" [formGroupName]="insIndex">
                                            <div>
                                                <div>
                                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                                        <p class="text-pink">
                                                            <b><small><strong>Insumo:</strong> {{ insumoSeleccionado.value.nombre }} 
                                                        </small></b></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div formArrayName="lotes">
                                                <table class="table table-sm table-borderless" *ngIf="insumoSeleccionado.value.lotes.length > 0">
                                                    <div *ngIf="salida; else entrada">
                                                        <thead>
                                                            <tr class="text-center">
                                                                <th scope="col">Lote</th>
                                                                <th scope="col">Unidades</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody *ngFor="let lote of itemLotes(insIndex).controls; let loteIndex=index" [formGroupName]="loteIndex">
                                                            <tr>
                                                                <td width="70%">
                                                                    <ngx-select
                                                                        [formControlName]="'lote'"
                                                                        [allowClear]="true"
                                                                        optionValueField="id"
                                                                        optionTextField="id"
                                                                        placeholder="Select..."
                                                                        [items]="this.getLotesSelect(insumoSeleccionado.value.id)"
                                                                        >
                                                                    </ngx-select>
                                                                </td>
                                                                <td width="30%">
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control" formControlName="cantidad" min="1" required (focusout)="onFocusOutCantidad(insIndex, insumoSeleccionado, loteIndex)"/>
                                                                        <div class="input-group-append">
                                                                            <label class="input-group-text">
                                                                                <span *ngIf="getPiezasDisponibles(insumoSeleccionado, loteIndex)">{{ getPiezasDisponibles(insumoSeleccionado, loteIndex) }}</span>
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td width="10px">
                                                                    <button type="button" class="btn-close d-flex align-items-center mt-2" (click)="removeItemLote(insIndex,loteIndex)">
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </div>
                                                    <ng-template #entrada>
                                                        <tr>
                                                            <thead>
                                                                <tr class="text-center">
                                                                    <th scope="col">Lote</th>
                                                                    <th scope="col">Fecha de caducidad</th>
                                                                    <th scope="col">Unidades</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody *ngFor="let lote of itemLotes(insIndex).controls; let loteIndex=index" [formGroupName]="loteIndex">
                                                                <tr>
                                                                    <td width="60%">
                                                                        <input type="text" class="form-control" formControlName="lote" required>
                                                                    </td>
                                                                    <td width="20%">
                                                                        <input type="date" class="form-control" formControlName="fechaCaducidad" required/>
                                                                    </td>
                                                                    <td width="20%">
                                                                        <div class="input-group">
                                                                            <input type="number" class="form-control" formControlName="cantidad" min="1" (focusout)="onFocusOutCantidad(insIndex, insumoSeleccionado, loteIndex)"/>
                                                                            <div class="input-group-append">
                                                                                <label class="input-group-text">
                                                                                {{ insumoSeleccionado.value.piezasPorLote }}
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td width="10px">
                                                                        <button type="button" class="btn-close d-flex align-items-center mt-2" (click)="removeItemLote(insIndex,loteIndex)">
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </tr>
                                                    </ng-template>
                                                </table>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-secondary btn-block" (click)="addItemLote(insIndex)"><i class="fas fa-plus"></i> Agregar lote de {{ insumoSeleccionado.value.nombre }}</button>
                                            </div>
                                        </div>
                                        <hr>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div *ngIf="mensajesDeError.length > 0" class="text-danger py-3">
                        <ul class="list-group">
                            <li class="list-group-item list-group-item-danger" *ngFor="let mensaje of mensajesDeError">{{ mensaje }}</li>
                        </ul>
                    </div>
                    <div class="text-center">
                        <button class="btn bg-pink">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>